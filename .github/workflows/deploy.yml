name: CI/CD Microservice

on:
  push:
    branches: [ master ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: action/checkout@v3

    - name: login to docker hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and Push All service
      run: |
          services=("auth-service" "user-service" "dokter-service" "booking-service" "notification-service")
          
          for service in "${services[@]}"; do
            echo "Building $service..."
            docker build -t ${{ secrets.DOCKER_USERNAME }}/$service:latest ./$service
            docker push ${{ secrets.DOCKER_USERNAME }}/$service:latest
          done

  deploy:
      needs: build-and-push
      runs-on: ubuntu-latest
      steps:
        - name: Deploy to AWS EC2
          uses: appleboy/ssh-action@master
          with:
            host: ${{ secrets.HOST_IP }}
            username: ubuntu
            key: ${{ secrets.SSH_PRIVATE_KEY }}
            script: |
              cd ~/backend  
              docker-compose pull
              docker-compose up -d --build
              docker image prune -f 